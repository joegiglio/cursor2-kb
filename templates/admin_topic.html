{% extends "base.html" %}
{% block content %}
<h1>{{ topic.name }} - Articles</h1>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }}" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<a href="{{ url_for('new_article', topic_id=topic.id) }}" class="btn btn-primary mb-3">New Article</a>

{% if articles %}
    <ul class="list-group" id="sortable-articles">
    {% for article in articles %}
        <li class="list-group-item d-flex justify-content-between align-items-center" data-id="{{ article.id }}">
            <span class="handle">&#9776;</span>
            {{ article.title }}
            <div>
                <a href="{{ url_for('edit_article', topic_id=topic.id, article_id=article.id) }}" class="btn btn-sm btn-primary">Edit</a>
                <form action="{{ url_for('delete_article', topic_id=topic.id, article_id=article.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this article?')">Delete</button>
                </form>
            </div>
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>No articles available.</p>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
$(document).ready(function() {
    var el = $('#sortable-articles')[0];
    var sortable = Sortable.create(el, {
        handle: '.handle',
        animation: 150,
        onEnd: function (evt) {
            var newOrder = $('#sortable-articles').children().map(function() {
                return $(this).data('id');
            }).get();
            
            $.ajax({
                url: '{{ url_for("update_article_sort_order", topic_id=topic.id) }}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({new_order: newOrder}),
                success: function(data) {
                    if (data.status === 'success') {
                        console.log('Article sort order updated successfully');
                    } else {
                        console.error('Failed to update article sort order');
                    }
                },
                error: function() {
                    console.error('Failed to update article sort order');
                }
            });
        },
    });
});
</script>
{% endblock %}